{% extends 'financeapp/loggedin_base.html' %}
{% load static %}
{% block title_block %} Zero-Based Budget - CapitalCompass {% endblock %}

{% block head_block %}
<link rel="stylesheet" href="{% static 'styles/new_layout.css' %}">
{% endblock %}

{% block body_block %}
<main>
    <section class="zero-based-budget-overview">
        <h1>{{ budget.budget_name }} Zero-Based Budget</h1>
        <div class="{% if money_available >= 0 %}money-positive{% else %}money-negative{% endif %}">
            {% if money_available >= 0 %}
                Available Money: £{{ money_available }} 
            {% else %}
                Warning: Negative Balance of £{{ money_available }} <button class="add-money" onclick="location.href='{% url 'financeapp:add_account' %}'"> Add Money </button>
            {% endif %}
        </div>
    </section>

    <section class="budget-details">  
        <div class="categories-container">
            {% for category in categories %}
            <div class="category-card">
                <div class="category-header">
                    <span class="category-name"><span class="name-category">{{ category.name }}</span><span class="budget"> Budget</span></span>
                    <span class="category-assigned"><span class="assigned-category">£{{ category.assigned_amount }}</span><span class="assigned"> Total Money Assigned </span></span>
                    <span class="category-activity"><span class="activity-category">£{{ category.activity }}</span><span class="activity"> Money Spent</span></span>
                </div>
                <div class="expenses-list">
                    {% for expense in category.expenses.all %}
                    <div class="expense-item">
                        <span class="expense-description">
                            <span class="description-expense">{{ expense.description }}</span>
                            <span class="expense"> Expense </span>
                        </span>
                        <span class="expense-assigned">
                            <span class="assigned-expense">£{{ expense.assigned_amount }}</span>
                            <span class="cost"> Cost </span>
                        </span>
                        <span class="expense-spent">
                            <span class="spent-container">
                                <span class="spent-paid-container">
                                    <span class="spent-expense">£{{ expense.spent }}</span>
                                    <span class="paid"> Paid </span>
                                </span>
                                    <span class="edit-icon" onclick="showEditExpenseForm('{{ expense.id }}', '{{ category.id }}', '{{ expense.description }}', '{{ expense.assigned_amount }}', '{{ expense.spent }}')">
                                        &#9998; <!-- Pencil icon -->
                                    </span>
                            </span>
                        </span>
                    </div>
                    
                    {% endfor %}
                </div>
                <div class="category-actions">
                    <button class="action-button" onclick="showEditCategoryForm('{{ category.id }}', '{{ category.name }}', '{{ category.assigned_amount }}')">Edit Category</button>
                    <button class="action-button" onclick="showAddExpenseForm({{ category.id }})">+ Add Expense</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <button class="add-category-button" onclick="showAddCategoryForm()">+ Add Category</button>
    </section>
   

<!-- Add Category Modal -->
<div id="add-category-form" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeAddCategoryForm()">&times;</span>
        <h2>New Category</h2>
        <form method="post" action="{% url 'financeapp:add_category' budget.id %}">
            {% csrf_token %}
            {{ category_form.as_p }}
            <div class="form-group submit-btn">
                <button type="submit" name="add_category" class="btn btn-primary">Add Category</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddCategoryForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="edit-category-form" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditCategoryForm()">&times;</span>
        <h2>Edit Category</h2>
        <form method="post" action="{% url 'financeapp:edit_category' budget.id %}">
            {% csrf_token %}
            <input type="hidden" name="category_id" id="edit-category-id">
            <div class="form-group">
                <label for="edit-category-name">Category Name:</label>
                <input type="text" name="name" id="edit-category-name" required>
            </div>
            <div class="form-group">
                <label for="edit-category-assigned-amount">Assigned Amount:</label>
                <input type="number" name="assigned_amount" id="edit-category-assigned-amount" required>
            </div>
            <div class="form-group submit-btn">
                <button type="submit" name="edit_category" class="btn btn-primary">Edit Category</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditCategoryForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Expense Modal -->
<div id="add-expense-form" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeAddExpenseForm()">&times;</span>
        <h2>New Expense</h2>
        <form method="post" action="{% url 'financeapp:add_expense' budget.id %}">
            {% csrf_token %}
            {{ expense_form.as_p }}
            <input type="hidden" name="category_id" id="expense-category-id">
            <div class="form-group submit-btn">
                <button type="submit" name="add_expense" class="btn btn-primary">Add Expense</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddExpenseForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Expense Modal -->
<div id="edit-expense-form" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditExpenseForm()">&times;</span>
        <h2>Edit Expense</h2>
        <form method="post" action="{% url 'financeapp:edit_expense' budget.id %}">
            {% csrf_token %}
            <input type="hidden" name="expense_id" id="edit-expense-id">
            <input type="hidden" name="category_id" id="edit-expense-category-id">
            <div class="form-group">
                <label for="edit-expense-description">Expense Description:</label>
                <input type="text" name="description" id="edit-expense-description" required>
            </div>
            <div class="form-group">
                <label for="edit-expense-assigned">Cost:</label>
                <input type="number" name="assigned_amount" id="edit-expense-assigned" required>
            </div>
            <div class="form-group">
                <label for="edit-expense-spent">Paid:</label>
                <input type="number" name="spent" id="edit-expense-spent" required>
            </div>
            <div class="form-group submit-btn">
                <button type="submit" name="edit_expense" class="btn btn-primary">Edit Expense</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditExpenseForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script> 
    /* add category */
    function showAddCategoryForm() {
        document.getElementById('add-category-form').style.display = 'flex';
    }
    function closeAddCategoryForm() {
        document.getElementById('add-category-form').style.display = 'none';
    }

    /* edit category */
    function showEditCategoryForm(categoryId, categoryName, assignedAmount) {
        document.getElementById('edit-category-form').style.display = 'flex';
        document.getElementById('edit-category-id').value = categoryId;
        document.getElementById('edit-category-name').value = categoryName;
        document.getElementById('edit-category-assigned-amount').value = assignedAmount;
    }

    function closeEditCategoryForm() {
        document.getElementById('edit-category-form').style.display = 'none';
    }

    /* add expense form */
    function showAddExpenseForm(categoryId) {
        document.getElementById('expense-category-id').value = categoryId;
        document.getElementById('add-expense-form').style.display = 'flex';
    }

    function closeAddExpenseForm() {
        document.getElementById('add-expense-form').style.display = 'none';
    }

    /* edit expense form */
    function showEditExpenseForm(expenseId, categoryId, expenseDescription, assignedAmount, spentAmount) {
        document.getElementById('edit-expense-id').value = expenseId;
        document.getElementById('edit-expense-category-id').value = categoryId;
        document.getElementById('edit-expense-description').value = expenseDescription;
        document.getElementById('edit-expense-assigned').value = assignedAmount;
        document.getElementById('edit-expense-spent').value = spentAmount;
        document.getElementById('edit-expense-form').style.display = 'flex';
    }
    
    function closeEditExpenseForm() {
        document.getElementById('edit-expense-form').style.display = 'none';
    }

    // Ensure modals are hidden by default on page load
    window.onload = function() {
        closeAddCategoryForm();
        closeEditCategoryForm();
        closeAddExpenseForm();
        closeEditExpenseForm();
    }
</script>
{% endblock %}
